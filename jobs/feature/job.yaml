- job-template:
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    name: '{component}-{osversion}-feature-testing-trigger'
    concurrent: false
    node: '{jslavelabel}'
    properties:
        - build-discarder:
            days-to-keep: 90
    wrappers:
        - ansicolor
        - workspace-cleanup
        - timestamps
    scm:
        - git:
            url: 'git://git.app.eng.bos.redhat.com/kvmqe-ci.git'
            branches:
                - origin/master
            basedir: kvmqe-ci
    triggers:
        - reverse:
            jobs: '{component}-{osversion}-trigger'
            result: 'success'
    builders:
        - conditional-step:
            condition-kind: 'build-cause'
            cause: 'UPSTREAM_CAUSE'
            on-evaluation-failure: 'dont-run'
            steps:
                - copyartifact:
                    project: '{component}-{osversion}-trigger'
                    filter: 'build-params.properties, static-repo.properties'
                    which-build: 'upstream-build'
                - inject:
                    properties-file: '$WORKSPACE/build-params.properties'
                - build-name-setter:
                    name: ''
                    file: false
                    template: '$BREW_NVR'
                    macro: true
                    macro-first: true
                - shell:
                    !include-raw: 'scripts/trigger.sh'
                - inject:
                    properties-file: '$WORKSPACE/job_mapping.properties'
        - trigger-builds:
          - project: '{component}-{osversion}-feature-runtest'
            predefined-parameters: |
                BREW_NVR=$BREW_NVR
                BREW_TAG=$BREW_TAG
                COMPOSE_ID=$COMPOSE_ID
                STATIC_REPO_URLS=$STATIC_REPO_URLS
            current-parameters: true
            same-node: true
            parameter-factories:
              - factory: counterbuild
                from: 1
                to: $JOB_NUM
                step: 1
                parameters: |
                    COUNT=$COUNT
    publishers:
        - archive:
            artifacts: 'changed-files.txt, job-mapping.csv, request-mapping.txt'
            allow-empty: true
        - email-ext:
            recipients: '{maintainers}'
            reply-to: '$DEFAULT_REPLYTO'
            content-type: 'default'
            subject: '$DEFAULT_SUBJECT'
            body: '$DEFAULT_CONTENT'
            attach-build-log: false
            failure: true
            matrix-trigger: 'only-configurations'
            send-to:
                - recipients


- job-template:
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    name: '{component}-{osversion}-feature-runtest'
    concurrent: true
    node: '{jslavelabel}'
    properties:
        - build-discarder:
            days-to-keep: 90
    wrappers:
        - ansicolor
        - workspace-cleanup
        - timestamps
    scm:
        - git:
            url: 'git://git.app.eng.bos.redhat.com/kvmqe-ci.git'
            branches:
                - origin/master
            basedir: kvmqe-ci
    builders:
        - conditional-step:
            condition-kind: 'build-cause'
            cause: 'UPSTREAM_CAUSE'
            on-evaluation-failure: 'dont-run'
            steps:
                - copyartifact:
                    project: '{component}-{osversion}-feature-testing-trigger'
                    filter: 'job-mapping.csv'
                    which-build: 'upstream-build'
                - inject:
                    properties-content: MAIL_RECIPIENTS=pingl@redhat.com
                - shell:
                    !include-raw: 'scripts/runtest.sh'
                - inject:
                    properties-file: '$WORKSPACE/feature.properties'
                - build-name-setter:
                    name: ''
                    file: false
                    template: '${{BREW_NVR}}.$ARCH - ${{COUNT}} - $FEATURE'
                    macro: true
                    macro-first: true
                - inject:
                    properties-file: '$WORKSPACE/beaker-job.properties'
        - conditional-step:
            condition-kind: 'shell'
            condition-command: |
                [ -n "${{BEAKER_JOB_ID// /}}" ]
            on-evaluation-failure: 'fail'
            steps:
                - description-setter:
                    description: '$BEAKER_JOB_ID ($BEAKER_JOB_LINK)'
                - shell:
                    !include-raw: 'scripts/publish.sh'
    publishers:
        - archive:
            artifacts: '*.properties'
            allow-empty: true
        - xunit:
            thresholdmode: 'number'
            thresholds:
                - failed:
                    unstable: 0
                    unstablenew: 0
                    failure: 0
                    failurenew: 0
                - skipped:
                    unstable: 0
                    unstablenew: 0
                    failure: 0
                    failurenew: 0
            types:
                - junit:
                    pattern: 'Result.xml'
                    deleteoutput: false
        - email-ext:
            recipients: '$MAIL_RECIPIENTS'
            reply-to: '$DEFAULT_REPLYTO'
            content-type: 'default'
            subject: '${{BREW_NVR}}.$ARCH - feature testing - $FEATURE - $BUILD_STATUS'
            body: '$DEFAULT_CONTENT'
            attach-build-log: true
            always: true
            failure: false
            pre-build: false
            matrix-trigger: 'only-configurations'
            send-to:
                - recipients
